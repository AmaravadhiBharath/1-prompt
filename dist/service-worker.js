var oe=Object.defineProperty;var ne=(r,e,t)=>e in r?oe(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var u=(r,e,t)=>ne(r,typeof e!="symbol"?e+"":e,t);import{r as M,c as ae,h as C}from"./firebase.js";import{_ as K}from"./preload-helper.js";class ie{deduplicatePrompts(e){if(e.length<=1)return e;const t=[],o=new Set;for(const i of e){const n=this.normalizeText(i.content);if(o.has(n))continue;let a=!1;for(const s of t)if(this.calculateSimilarity(n,this.normalizeText(s.content))>.85){a=!0;break}a||(o.add(n),t.push(i))}return t}normalizeText(e){return e.toLowerCase().trim().replace(/\s+/g," ").replace(/[^\w\s]/g,"")}calculateSimilarity(e,t){if(e===t)return 1;if(!e.length||!t.length)return 0;if(e.includes(t)||t.includes(e)){const a=Math.min(e.length,t.length),s=Math.max(e.length,t.length);return a/s}const o=new Set(e.split(" ").filter(a=>a.length>2)),i=new Set(t.split(" ").filter(a=>a.length>2));if(!o.size||!i.size)return 0;let n=0;for(const a of o)i.has(a)&&n++;return n/Math.max(o.size,i.size)}formatSummary(e){return this.deduplicatePrompts(e).map(n=>{let a=n.content.trim();return!a.endsWith(".")&&!a.endsWith("?")&&!a.endsWith("!")&&(a+="."),a}).join(" ")+`

âš¡ Summary by Local Client-Side Logic (Fallback)`}async summarize(e){if(e.length===0)throw new Error("No prompts to summarize");try{const t=window.ai;if(t&&t.languageModel&&(await t.languageModel.capabilities()).available!=="no"){const i=await t.languageModel.create(),a=`Summarize these prompts into a single, consolidated paragraph. No filler. No intro. Just the action items:

${e.map(c=>c.content).join(`
`)}`,s=await i.prompt(a);return{original:e,summary:s+`

âš¡ Summary by Local Gemini Nano (Chrome Built-in)`,promptCount:{before:e.length,after:e.length}}}}catch(t){console.warn("[LocalSummarizer] Gemini Nano failed or not available, falling back to logic:",t)}try{const t=this.formatSummary(e),o=this.deduplicatePrompts(e);return{original:e,summary:t,promptCount:{before:e.length,after:o.length}}}catch(t){throw console.error("[LocalSummarizer] Error:",t),t}}}const W=new ie;var Y={};const b={primary:{provider:"auto",model:"gpt-4o-mini",timeout:3e4,maxTokens:4e3,temperature:.3},fallbacks:[{provider:"anthropic",model:"claude-3-haiku-20240307",timeout:3e4,maxTokens:4e3,temperature:.3,isFallback:!0},{provider:"gemini",model:"gemini-1.5-flash",timeout:3e4,maxTokens:4e3,temperature:.3,isFallback:!0}],settings:{autoFallback:!0,retryAttempts:2,rateLimit:{requestsPerMinute:60,requestsPerHour:1e3}},environments:{development:{primary:{provider:"openai",model:"gpt-4o-mini",temperature:.5}},production:{settings:{autoFallback:!0,retryAttempts:3}}}},N={openai:["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-4","gpt-3.5-turbo"],anthropic:["claude-3-5-sonnet-20241022","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"],gemini:["gemini-1.5-pro","gemini-1.5-flash","gemini-1.0-pro"],cohere:["command-r-plus","command-r","command","command-nightly"],auto:[]};function O(r,e){var t;return typeof globalThis<"u"&&Y?Y[r]||e:typeof window<"u"&&((t=window.process)!=null&&t.env)&&window.process.env[r]||e}function se(){let r={...b};const e=O("AI_PROVIDER"),t=O("AI_API_KEY"),o=O("AI_MODEL"),i=O("AI_ENDPOINT");e&&N[e]&&(r.primary.provider=e),t&&(r.primary.apiKey=t),o&&(r.primary.model=o),i&&(r.primary.endpoint=i);const n=O("NODE_ENV","production");return r.environments[n]&&(r=ce(r,r.environments[n])),r}function ce(r,e){return{primary:{...r.primary,...e.primary},fallbacks:e.fallbacks||r.fallbacks,settings:{...r.settings,...e.settings},environments:{...r.environments,...e.environments}}}function B(r){const e=[];(!r.primary.provider||!N[r.primary.provider])&&e.push(`Invalid primary provider: ${r.primary.provider}`),r.primary.model&&r.primary.provider!=="auto"&&(N[r.primary.provider].includes(r.primary.model)||e.push(`Model ${r.primary.model} is not valid for provider ${r.primary.provider}`));for(const t of r.fallbacks)(!t.provider||!N[t.provider])&&e.push(`Invalid fallback provider: ${t.provider}`);return r.primary.timeout&&r.primary.timeout<1e3&&e.push("Timeout must be at least 1000ms"),r.primary.temperature!==void 0&&(r.primary.temperature<0||r.primary.temperature>1)&&e.push("Temperature must be between 0 and 1"),{valid:e.length===0,errors:e}}function G(r,e){if(e.apiKey)return e.apiKey;const t={openai:"OPENAI_API_KEY",anthropic:"ANTHROPIC_API_KEY",gemini:"GEMINI_API_KEY",cohere:"COHERE_API_KEY"},o=O(t[r]);if(o)return o;throw new Error(`No API key found for provider ${r}. Set ${t[r]} environment variable or configure in config file.`)}class J{constructor(){u(this,"name","openai");u(this,"models",["gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-4","gpt-3.5-turbo"]);u(this,"config");u(this,"apiKey")}async initialize(e){this.config=e,this.apiKey=G("openai",e)}async chat(e){var a,s,c,l,d;const t=this.config.endpoint||"https://api.openai.com/v1/chat/completions",o={model:this.config.model||"gpt-4o-mini",messages:e.messages,temperature:e.temperature||this.config.temperature||.3,max_tokens:e.maxTokens||this.config.maxTokens||4e3,stream:e.stream||!1},i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify(o)});if(!i.ok){const m=await i.text();throw new Error(`OpenAI API Error: ${i.status} ${m}`)}const n=await i.json();return{content:((s=(a=n.choices[0])==null?void 0:a.message)==null?void 0:s.content)||"",usage:{promptTokens:((c=n.usage)==null?void 0:c.prompt_tokens)||0,completionTokens:((l=n.usage)==null?void 0:l.completion_tokens)||0,totalTokens:((d=n.usage)==null?void 0:d.total_tokens)||0},model:n.model,provider:"openai"}}async isAvailable(){try{return(await fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:`Bearer ${this.apiKey}`}})).ok}catch{return!1}}getEndpoint(){return this.config.endpoint||"https://api.openai.com/v1/chat/completions"}}class Z{constructor(){u(this,"name","anthropic");u(this,"models",["claude-3-5-sonnet-20241022","claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"]);u(this,"config");u(this,"apiKey")}async initialize(e){this.config=e,this.apiKey=G("anthropic",e)}async chat(e){var c,l,d,m,h;const t=this.config.endpoint||"https://api.anthropic.com/v1/messages",o=e.messages.find(p=>p.role==="system"),i=e.messages.filter(p=>p.role!=="system"),n={model:this.config.model||"claude-3-haiku-20240307",max_tokens:e.maxTokens||this.config.maxTokens||4e3,temperature:e.temperature||this.config.temperature||.3,system:o==null?void 0:o.content,messages:i.map(p=>({role:p.role==="assistant"?"assistant":"user",content:p.content}))},a=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":"2023-06-01"},body:JSON.stringify(n)});if(!a.ok){const p=await a.text();throw new Error(`Anthropic API Error: ${a.status} ${p}`)}const s=await a.json();return{content:((c=s.content[0])==null?void 0:c.text)||"",usage:{promptTokens:((l=s.usage)==null?void 0:l.input_tokens)||0,completionTokens:((d=s.usage)==null?void 0:d.output_tokens)||0,totalTokens:(((m=s.usage)==null?void 0:m.input_tokens)||0)+(((h=s.usage)==null?void 0:h.output_tokens)||0)},model:s.model,provider:"anthropic"}}async isAvailable(){try{const e=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"x-api-key":this.apiKey,"anthropic-version":"2023-06-01","content-type":"application/json"},body:JSON.stringify({model:"claude-3-haiku-20240307",max_tokens:10,messages:[{role:"user",content:"test"}]})});return e.status===200||e.status===429}catch{return!1}}getEndpoint(){return this.config.endpoint||"https://api.anthropic.com/v1/messages"}}class Q{constructor(){u(this,"name","gemini");u(this,"models",["gemini-1.5-pro","gemini-1.5-flash","gemini-1.0-pro"]);u(this,"config");u(this,"apiKey")}async initialize(e){this.config=e,this.apiKey=G("gemini",e)}async chat(e){var d,m,h,p,f,S,v,L;const t=this.config.model||"gemini-1.5-flash",o=this.config.endpoint||`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent?key=${this.apiKey}`,i=e.messages.filter(T=>T.role!=="system").map(T=>({role:T.role==="assistant"?"model":"user",parts:[{text:T.content}]})),n=(d=e.messages.find(T=>T.role==="system"))==null?void 0:d.content,a={contents:i,generationConfig:{temperature:e.temperature||this.config.temperature||.3,maxOutputTokens:e.maxTokens||this.config.maxTokens||4e3}};n&&(a.systemInstruction={parts:[{text:n}]});const s=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!s.ok){const T=await s.text();throw new Error(`Gemini API Error: ${s.status} ${T}`)}const c=await s.json(),l=(m=c.candidates)==null?void 0:m[0];return{content:((f=(p=(h=l==null?void 0:l.content)==null?void 0:h.parts)==null?void 0:p[0])==null?void 0:f.text)||"",usage:{promptTokens:((S=c.usageMetadata)==null?void 0:S.promptTokenCount)||0,completionTokens:((v=c.usageMetadata)==null?void 0:v.candidatesTokenCount)||0,totalTokens:((L=c.usageMetadata)==null?void 0:L.totalTokenCount)||0},model:t,provider:"gemini"}}async isAvailable(){try{const e=this.config.model||"gemini-1.5-flash";return(await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${e}?key=${this.apiKey}`,{method:"GET"})).ok}catch{return!1}}getEndpoint(){const e=this.config.model||"gemini-1.5-flash";return this.config.endpoint||`https://generativelanguage.googleapis.com/v1beta/models/${e}:generateContent`}}class le{constructor(){u(this,"name","auto");u(this,"models",[]);u(this,"providers",[]);u(this,"selectedProvider",null)}async initialize(e){this.providers=[new J,new Z,new Q];for(const t of this.providers)try{if(await t.initialize(e),await t.isAvailable()){this.selectedProvider=t,console.log(`[AutoProvider] Selected ${t.name} as primary provider`);break}}catch(o){console.warn(`[AutoProvider] Provider ${t.name} unavailable:`,o)}if(!this.selectedProvider)throw new Error("No AI providers are available")}async chat(e){if(!this.selectedProvider)throw new Error("Auto provider not initialized");return await this.selectedProvider.chat(e)}async isAvailable(){return this.selectedProvider!==null}getEndpoint(){var e;return((e=this.selectedProvider)==null?void 0:e.getEndpoint())||""}}class k{static async getProvider(e,t){if(this.providers.has(e)){const i=this.providers.get(e);return await i.initialize(t),i}let o;switch(e){case"openai":o=new J;break;case"anthropic":o=new Z;break;case"gemini":o=new Q;break;case"auto":o=new le;break;default:throw new Error(`Unsupported AI provider: ${e}`)}return await o.initialize(t),this.providers.set(e,o),o}static clearCache(){this.providers.clear()}}u(k,"providers",new Map);const E=class E{constructor(){u(this,"config",b);u(this,"sources",[]);u(this,"lastUpdate",0);u(this,"updateInterval",5*60*1e3);u(this,"isLoading",!1);this.initializeSources()}static getInstance(){return E.instance||(E.instance=new E),E.instance}initializeSources(){this.sources=[{name:"environment",priority:1,load:this.loadFromEnvironment.bind(this)},{name:"remote-admin",priority:2,load:this.loadFromRemoteAdmin.bind(this)},{name:"remote-config",priority:3,load:this.loadFromRemoteConfig.bind(this)},{name:"runtime-config",priority:2.5,load:this.loadFromRuntimeConfig.bind(this)},{name:"local-storage",priority:4,load:this.loadFromLocalStorage.bind(this)}],this.sources.sort((e,t)=>e.priority-t.priority)}async getConfig(){return Date.now()-this.lastUpdate>this.updateInterval&&await this.refreshConfig(),this.config}async refreshConfig(){if(!this.isLoading){this.isLoading=!0,console.log("[DynamicConfigLoader] ðŸ”„ Refreshing AI configuration...");try{let e={...b};for(const o of[...this.sources].reverse())try{const i=await o.load();i&&(e=this.mergeConfigs(e,i),console.log(`[DynamicConfigLoader] âœ… Loaded config from ${o.name}`))}catch(i){console.warn(`[DynamicConfigLoader] âš ï¸ Failed to load from ${o.name}:`,i)}const t=B(e);t.valid||(console.error("[DynamicConfigLoader] âŒ Invalid configuration:",t.errors),console.log("[DynamicConfigLoader] ðŸ”§ Using default configuration as fallback"),e=b),this.config=e,this.lastUpdate=Date.now(),console.log(`[DynamicConfigLoader] ðŸŽ¯ Using provider: ${this.config.primary.provider} (${this.config.primary.model})`),await this.saveToLocalStorage(this.config)}catch(e){console.error("[DynamicConfigLoader] âŒ Failed to refresh config:",e)}finally{this.isLoading=!1}}}async loadFromEnvironment(){try{const e=se();return e.primary.provider!==b.primary.provider||e.primary.apiKey||e.primary.model!==b.primary.model?e:null}catch(e){return console.warn("[DynamicConfigLoader] Environment config load failed:",e),null}}async loadFromRemoteAdmin(){try{const e=this.getAdminConfigUrl();if(!e)return null;const t=await M(e,{method:"GET",headers:{"Content-Type":"application/json"}});if(!t.ok)return null;const o=await t.json();return console.log("[DynamicConfigLoader] ðŸ“¡ Remote admin config loaded"),o}catch{return null}}async loadFromRuntimeConfig(){try{const{config:e}=await K(async()=>{const{config:o}=await import("./firebase.js").then(i=>i.i);return{config:o}},[],import.meta.url);await e.load();const t=e.ai;return t&&t.defaultProvider!=="auto"?{primary:{provider:t.defaultProvider,model:t.model}}:null}catch(e){return console.warn("[DynamicConfigLoader] Runtime config load failed:",e),null}}async loadFromRemoteConfig(){try{const t=(await K(async()=>{const{RemoteConfigService:o}=await Promise.resolve().then(()=>he);return{RemoteConfigService:o}},void 0,import.meta.url)).RemoteConfigService.getInstance().getAIConfig();return t&&t.defaultProvider!=="auto"?{primary:{provider:t.defaultProvider,model:t.model}}:null}catch(e){return console.warn("[DynamicConfigLoader] Remote config load failed:",e),null}}async loadFromLocalStorage(){try{const e=await chrome.storage.local.get(["ai_configuration_cache"]);if(e.ai_configuration_cache){const t=JSON.parse(e.ai_configuration_cache),o=24*60*60*1e3;if(t.timestamp&&Date.now()-t.timestamp<o)return t.config}return null}catch(e){return console.warn("[DynamicConfigLoader] Local storage load failed:",e),null}}async saveToLocalStorage(e){try{const t={config:e,timestamp:Date.now()};await chrome.storage.local.set({ai_configuration_cache:JSON.stringify(t)})}catch(t){console.warn("[DynamicConfigLoader] Failed to save to local storage:",t)}}getAdminConfigUrl(){try{chrome.storage.sync.get(["ai_admin_config_url"],e=>e.ai_admin_config_url||null)}catch{}return"https://1prompt-backend.amaravadhibharath.workers.dev/admin/ai-config"}mergeConfigs(e,t){return{primary:{...e.primary,...t.primary},fallbacks:t.fallbacks||e.fallbacks,settings:{...e.settings,...t.settings},environments:e.environments}}async updateProvider(e,t,o){try{const i={primary:{...this.config.primary,provider:e,model:t||this.config.primary.model,apiKey:o||this.config.primary.apiKey}},n=this.mergeConfigs(this.config,i),a=B(n);return a.valid?(this.config=n,await this.saveToLocalStorage(this.config),console.log(`[DynamicConfigLoader] âœ… Provider updated to ${e} (${t||"default model"})`),!0):(console.error("[DynamicConfigLoader] âŒ Invalid provider update:",a.errors),!1)}catch(i){return console.error("[DynamicConfigLoader] âŒ Failed to update provider:",i),!1}}getCurrentProviderInfo(){return{provider:this.config.primary.provider,model:this.config.primary.model,source:"dynamic"}}};u(E,"instance");let x=E;const I=x.getInstance(),H=`[INTENT COMPILATION PROTOCOL v5.1 - ENTERPRISE]

CORE DIRECTIVE: Compile user intent into a single, cohesive paragraph.
PHILOSOPHY: 1prompt does not summarize conversations. It compiles intent into a unified narrative.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECTION A: OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

A1. SINGLE PARAGRAPH ONLY
- Output MUST be a single, justified-style paragraph.
- No bullet points, no numbered lists, no newlines within the text.
- Merge all requirements into a continuous flow.

A2. NO CATEGORY HEADERS
- Do NOT use prefixes like "Story requirement:", "Color elements:", "Output:", "Request:".
- Start sentences directly with the subject.
- âœ— "Story requirement: A story about a cat."
- âœ“ "Create a story about a cat..."

A3. FINAL STATE ONLY
- Output the resolved state of all requirements
- No temporal language: "initially", "later", "then", "changed to"
- No conversation narration
- âœ— "User first wanted blue, then green"
- âœ“ "The design should use green coloring."

A4. PURE INSTRUCTION ONLY (OUTPUT-ONLY)
- No headers like "Project Specification" or "Summary"
- No intro sentences like "The project entails..." or "The user wants..."
- Start directly with the commands.

A10. NO INTENT FALLBACK
- If no actionable instruction exists after processing, prepend [unprocessed: no actionable intent detected] and preserve raw input verbatim.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECTION B: ZERO INFORMATION LOSS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

B1. INCLUDE EVERYTHING
- Every noun, constraint, requirement mentioned ONCE must appear
- Single mentions are equally important as repeated ones

B2. COHESIVE NARRATIVE
- Weave distinct requirements into the paragraph naturally.
- Instead of "Colors: red, blue.", use "The visual elements should incorporate red and blue colors."

B3. DEDUPLICATION WITHOUT LOSS
- Identical statements â†’ merge into ONE complete version

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECTION C: CONFLICT RESOLUTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

C1. LATEST WINS (OVERRIDE SUPREMACY)
- Latest explicit instruction takes precedence.
- Remove earlier conflicting instruction completely.
- Do not reference discarded states.

C2. SPECIFICITY OVERRIDE
- Specific overrides generic.
- "Make colorful" â†’ "Use blue and white only" = "Use blue and white only."

[END PROTOCOL v5.1]`,w=class w{constructor(){u(this,"backendUrl","https://1prompt-backend.amaravadhibharath.workers.dev")}static getInstance(){return w.instance||(w.instance=new w),w.instance}async summarize(e,t={}){if(!e.length)throw new Error("No prompts provided for summarization");console.log(`[EnhancedAISummarizer] ðŸ“ Starting summarization of ${e.length} prompts`);try{const o=await I.getConfig();if(console.log(`[EnhancedAISummarizer] ðŸŽ¯ Using provider: ${o.primary.provider} (${o.primary.model})`),(t.useDirectProvider||o.primary.provider!=="auto"&&o.settings.autoFallback)&&o.primary.apiKey)try{return await this.summarizeWithDirectProvider(e,t,o)}catch(n){return console.warn("[EnhancedAISummarizer] Direct provider failed, trying backend...",n),await this.summarizeWithBackend(e,t,o)}else return await this.summarizeWithBackend(e,t,o)}catch(o){return console.error("[EnhancedAISummarizer] âŒ Primary method failed:",o),await this.fallbackSummarize(e,t)}}async summarizeWithDirectProvider(e,t,o){console.log("[EnhancedAISummarizer] ðŸ”§ Using direct provider mode");try{const i=await k.getProvider(o.primary.provider,o.primary),n=this.prepareContent(e),s={messages:[{role:"system",content:H},{role:"user",content:`Please consolidate these user prompts into a single, cohesive paragraph:

${n}`}],temperature:o.primary.temperature||.3,maxTokens:o.primary.maxTokens||4e3},c=await i.chat(s);return console.log(`[EnhancedAISummarizer] âœ… Direct provider summary received (${c.content.length} chars)`),{original:e,summary:c.content.trim(),promptCount:{before:e.length,after:e.length},provider:c.provider,model:c.model,usage:c.usage}}catch(i){throw console.error("[EnhancedAISummarizer] âŒ Direct provider failed:",i),i}}async summarizeWithBackend(e,t,o){console.log("[EnhancedAISummarizer] ðŸŒ Using backend mode");try{const i=this.prepareContent(e),n=await M(this.backendUrl,{method:"POST",headers:{"Content-Type":"application/json",...t.authToken?{Authorization:`Bearer ${t.authToken}`}:{}},body:JSON.stringify({content:i,additionalInfo:H,provider:o.primary.provider,model:o.primary.model,apiKey:o.primary.apiKey,userId:t.userId,userEmail:t.userEmail,options:{format:t.format||"paragraph",tone:t.tone||"normal",includeAI:t.includeAI||!1,mode:"consolidate"}})});if(!n.ok){const s=await n.json();throw new Error(s.error||`Backend error: ${n.status}`)}const a=await n.json();return{original:e,summary:a.summary,promptCount:{before:e.length,after:e.length},provider:a.provider||o.primary.provider,model:a.model||o.primary.model}}catch(i){throw console.error("[EnhancedAISummarizer] âŒ Backend method failed:",i),i}}async fallbackSummarize(e,t){console.log("[EnhancedAISummarizer] ðŸ”„ Falling back to local summarization");try{const o=await I.getConfig();for(const i of o.fallbacks)try{if(await(await k.getProvider(i.provider,i)).isAvailable())return console.log(`[EnhancedAISummarizer] ðŸ”„ Trying fallback provider: ${i.provider}`),await this.summarizeWithDirectProvider(e,t,{primary:i})}catch(n){console.warn(`[EnhancedAISummarizer] Fallback provider ${i.provider} failed:`,n)}return await W.summarize(e)}catch(o){console.error("[EnhancedAISummarizer] âŒ All fallback methods failed:",o);const i=this.prepareContent(e);return{original:e,summary:i.length>4e3?i.substring(0,4e3)+"...":i,promptCount:{before:e.length,after:1},provider:"local",model:"fallback"}}}prepareContent(e){return e.map((t,o)=>`${o+1}. ${t.content.trim()}`).join(`

`)}async testProvider(){try{const e=await I.getConfig();return await(await k.getProvider(e.primary.provider,e.primary)).isAvailable()?{success:!0,provider:`${e.primary.provider} (${e.primary.model})`}:{success:!1,provider:`${e.primary.provider} (${e.primary.model})`,error:"Provider is not available"}}catch(e){return{success:!1,provider:"unknown",error:e instanceof Error?e.message:String(e)}}}async getConfigInfo(){try{const e=await I.getConfig();return{primary:e.primary,fallbacks:e.fallbacks.map(t=>({provider:t.provider,model:t.model})),settings:e.settings,lastUpdate:I.lastUpdate}}catch(e){return{error:e instanceof Error?e.message:String(e)}}}async refreshConfiguration(){await I.refreshConfig(),k.clearCache()}};u(w,"instance");let F=w;const me=F.getInstance(),q="https://1prompt-backend.amaravadhibharath.workers.dev",ue=`[INTENT COMPILATION PROTOCOL v5.1 - ENTERPRISE]

CORE DIRECTIVE: Compile user intent into a single, cohesive paragraph.
PHILOSOPHY: 1prompt does not summarize conversations. It compiles intent into a unified narrative.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECTION A: OUTPUT FORMAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

A1. SINGLE PARAGRAPH ONLY
- Output MUST be a single, justified-style paragraph.
- No bullet points, no numbered lists, no newlines within the text.
- Merge all requirements into a continuous flow.

A2. NO CATEGORY HEADERS
- Do NOT use prefixes like "Story requirement:", "Color elements:", "Output:", "Request:".
- Start sentences directly with the subject.
- âœ— "Story requirement: A story about a cat."
- âœ“ "Create a story about a cat..."

A3. FINAL STATE ONLY
- Output the resolved state of all requirements
- No temporal language: "initially", "later", "then", "changed to"
- No conversation narration
- âœ— "User first wanted blue, then green"
- âœ“ "The design should use green coloring."

A4. PURE INSTRUCTION ONLY (OUTPUT-ONLY)
- No headers like "Project Specification" or "Summary"
- No intro sentences like "The project entails..." or "The user wants..."
- Start directly with the commands.

A10. NO INTENT FALLBACK
- If no actionable instruction exists after processing, prepend [unprocessed: no actionable intent detected] and preserve raw input verbatim.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECTION B: ZERO INFORMATION LOSS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

B1. INCLUDE EVERYTHING
- Every noun, constraint, requirement mentioned ONCE must appear
- Single mentions are equally important as repeated ones

B2. COHESIVE NARRATIVE
- Weave distinct requirements into the paragraph naturally.
- Instead of "Colors: red, blue.", use "The visual elements should incorporate red and blue colors."

B3. DEDUPLICATION WITHOUT LOSS
- Identical statements â†’ merge into ONE complete version

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECTION C: CONFLICT RESOLUTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

C1. LATEST WINS (OVERRIDE SUPREMACY)
- Latest explicit instruction takes precedence.
- Remove earlier conflicting instruction completely.
- Do not reference discarded states.

C2. SPECIFICITY OVERRIDE
- Specific overrides generic.
- "Make colorful" â†’ "Use blue and white only" = "Use blue and white only."

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SECTION D: STYLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

D1. PROFESSIONAL & DIRECT
- Use professional, imperative or descriptive language.
- "The story requires a mouse..." not "You should write a story about a mouse..."

D2. NO META-COMMENTARY
- No "Here is the summary" or "Based on the transcript".
- Just the content.

[END PROTOCOL v5.1]
`;class de{async summarize(e,t={}){if(!e||e.length===0)return console.log("[AISummarizer] ðŸ“ No prompts to summarize"),{original:[],summary:"",promptCount:{before:0,after:0}};console.log(`[AISummarizer] ðŸ“ Starting AI summarization for ${e.length} prompts`);try{const o=await me.summarize(e,{format:t.format,tone:t.tone,includeAI:t.includeAI,userId:t.userId,userEmail:t.userEmail,authToken:t.authToken,useDirectProvider:!1});return console.log(`[AISummarizer] âœ… Enhanced AI summary completed via ${o.provider||"backend"}`),o}catch(o){return console.warn("[AISummarizer] âš ï¸ Enhanced summarizer failed, trying legacy backend...",o),await this.legacySummarize(e,t)}}async legacySummarize(e,t={}){var o,i;try{const n=e.map((m,h)=>`${h+1}. ${m.content}`).join(`

`);console.log(`[AISummarizer] â±ï¸ Attempting legacy backend at ${q}`),console.log(`[AISummarizer] ðŸ“ Sending ${e.length} raw prompts (${n.length} chars)`);const a=await I.getConfig(),s=a.primary.provider,c=a.primary.model,l=await M(q,{method:"POST",headers:{"Content-Type":"application/json",...t.authToken?{Authorization:`Bearer ${t.authToken}`}:{}},body:JSON.stringify({content:n,additionalInfo:ue,provider:s,model:c,userId:t.userId,userEmail:t.userEmail,options:{format:t.format||"paragraph",tone:t.tone||"normal",includeAI:t.includeAI||!1,mode:"consolidate"}})});if(console.log(`[AISummarizer] ðŸ“¡ Backend response: ${l.status} ${l.statusText}`),!l.ok){let m=`Worker Error: ${l.status}`;try{m=(await l.json()).error||m}catch{m=`${l.status} ${l.statusText}`}throw console.error(`[AISummarizer] âŒ Backend failed: ${m}`),new Error(m)}const d=await l.json();if(console.log(`[AISummarizer] âœ… AI Summary received (${((o=d.summary)==null?void 0:o.length)||0} chars): ${(i=d.summary)==null?void 0:i.slice(0,100)}...`),!d.summary||d.summary.trim().length===0)throw console.error("[AISummarizer] âŒ AI returned empty summary"),new Error("AI returned an empty summary.");return{original:e,summary:d.summary,promptCount:{before:e.length,after:e.length},model:d.model,provider:d.provider}}catch(n){console.error("[AISummarizer] âŒ Cloud AI failed:",(n==null?void 0:n.message)||n),console.error("[AISummarizer] âš ï¸ Falling back to local client-side summarization...");try{const a=await W.summarize(e);return console.log("[AISummarizer] âš™ï¸ Using local summary as fallback (Client-Side)"),a}catch(a){throw console.error("[AISummarizer] âŒ Local summarization also failed:",a),n}}}}const U=new de;async function pe(){console.log("[AISummarizer] Using Cloudflare Worker backend with smart filtering")}const $={version:1,platforms:{chatgpt:{userSelectors:['[data-message-author-role="user"]',".user-message"],buttonSelectors:['button[data-testid="send-button"]'],inputSelectors:["#prompt-textarea"]},claude:{userSelectors:[".font-user-message",'[data-test-id="user-message"]'],buttonSelectors:['button[aria-label="Send Message"]'],inputSelectors:['div[contenteditable="true"]']}},aiConfig:{defaultProvider:"auto"}},R="remote_selector_config",ge="https://raw.githubusercontent.com/bharathamaravadi/sauce-config/main/selectors.json",ee=24*60*60*1e3,P="remote_config_last_fetch",A=class A{constructor(){u(this,"config",$)}static getInstance(){return A.instance||(A.instance=new A),A.instance}async initialize(){const e=await chrome.storage.local.get([R,P]);e[R]&&(this.config={...$,...e[R]})}getSelectors(e){return this.config.platforms[e]||null}getAIConfig(){return this.config.aiConfig||$.aiConfig}};u(A,"instance");let _=A;const he=Object.freeze(Object.defineProperty({__proto__:null,CACHE_TTL:ee,LAST_FETCH_KEY:P,REMOTE_URL:ge,RemoteConfigService:_,STORAGE_KEY:R},Symbol.toStringTag,{value:"Module"}));async function fe(r){try{const e=await M(`${ae.backend.url}/config/selectors`,{method:"GET"});if(e.ok){const o=(await e.json()).config;o&&o.version&&o.version>r&&(console.log("[RemoteConfig] New version found:",o.version),await chrome.storage.local.set({[R]:o}))}await chrome.storage.local.set({[P]:Date.now()})}catch(e){console.warn("[RemoteConfig] Update failed, using cached config:",e)}}typeof self<"u"&&typeof window>"u"&&(self.window=self);console.log("[1prompt] Service worker started");pe();try{_.getInstance().initialize().then(async()=>{try{const e=(await chrome.storage.local.get([P]))[P]||0;if(Date.now()-e>ee){const t=_.getInstance().config;fe((t==null?void 0:t.version)||0).catch(o=>{console.error("[1prompt] Remote config update failed:",o)})}}catch(r){console.error("[1prompt] Error checking remote config cache:",r)}}).catch(r=>{console.error("[1prompt] Remote config initialization failed:",r)})}catch(r){console.error("[1prompt] Critical error initializing remote config:",r)}self.addEventListener("unhandledrejection",r=>{console.error("[1prompt] Unhandled rejection in service worker:",r.reason),r.preventDefault()});chrome.alarms.create("keepAlive",{periodInMinutes:.5});chrome.alarms.create("syncPrompts",{periodInMinutes:5});chrome.alarms.onAlarm.addListener(async r=>{if(r.name==="keepAlive")console.log("[1prompt] Keep-alive ping at",new Date().toISOString());else if(r.name==="syncPrompts"){console.log("[1prompt] Triggering prompt sync...");try{const e=await chrome.tabs.query({url:["*://*.openai.com/*","*://*.anthropic.com/*","*://*.google.com/*","*://*.perplexity.ai/*","*://*.deepseek.com/*","*://*.lovable.dev/*","*://*.bolt.new/*","*://*.cursor.sh/*","*://*.meta.ai/*"]});for(const t of e)t.id&&chrome.tabs.sendMessage(t.id,{action:"TRIGGER_CLOUD_SYNC"}).catch(()=>{})}catch(e){console.error("[1prompt] Sync alarm error:",e)}}});let y=null,j=null;chrome.sidePanel?chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(r=>console.warn("[1prompt] SidePanel setup failed:",r)):(console.warn("[1prompt] SidePanel API not available, falling back to popup"),chrome.action.setPopup({popup:"sidepanel/index.html"}));chrome.runtime.onConnect.addListener(r=>{r.name==="sidepanel"&&(console.log("[1prompt SW] ðŸŸ¢ Side panel connected"),D(),y&&chrome.runtime.sendMessage({action:"EXTRACTION_RESULT",result:y}).catch(()=>{}),j&&Date.now()-j.timestamp<3e3&&(console.log("[1prompt] Replaying pending trigger to new sidepanel"),chrome.runtime.sendMessage({action:"EXTRACT_TRIGERED_FROM_PAGE"}).catch(()=>{})),r.onMessage.addListener(e=>{te(e)}),r.onDisconnect.addListener(()=>{console.log("[1prompt SW] ðŸ”´ Side panel disconnected")}))});async function ye(r){try{console.log("[1prompt] Metrics tracking temporarily disabled during migration")}catch{}}chrome.runtime.onMessage.addListener((r,e,t)=>{var o;switch(console.log("[1prompt] Received message:",r.action),r.action){case"EXTRACT_PROMPTS":case"SUMMARIZE_PROMPTS":case"GET_STATUS":return te(r),t({success:!0}),!0;case"SET_USER_ID":{const{userId:n}=r;return n?chrome.storage.local.set({firebase_current_user_id:n},()=>{console.log("[1prompt SW] User ID set in local storage:",n),t({success:!0})}):chrome.storage.local.remove("firebase_current_user_id",()=>{console.log("[1prompt SW] User ID removed from local storage"),t({success:!0})}),!0}case"SYNC_PROMPT_TO_CLOUD":{const{prompt:n,platform:a}=r;return i([n],a,t),!0}case"SYNC_PROMPTS_TO_CLOUD":{const{prompts:n,platform:a}=r;return i(n,a,t),!0}case"COPY_TEXT":{const{text:n}=r;return(async()=>{try{const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});if(a!=null&&a.id)await chrome.scripting.executeScript({target:{tabId:a.id},func:s=>{navigator.clipboard.writeText(s).catch(()=>{const c=document.createElement("textarea");c.value=s,c.style.position="fixed",c.style.left="-9999px",document.body.appendChild(c),c.focus(),c.select();try{document.execCommand("copy")}catch(l){console.error("Fallback copy failed",l)}document.body.removeChild(c)})},args:[n]}),t({success:!0});else throw new Error("No active tab found to execute copy")}catch(a){console.error("Background copy failed",a),t({success:!1,error:String(a)})}})(),!0}case"OPEN_SIDE_PANEL":{(async()=>{var n,a;try{console.log("[1prompt] OPEN_SIDE_PANEL received from tab:",(n=e.tab)==null?void 0:n.id);let s=(a=e.tab)==null?void 0:a.windowId;if(!s){console.log("[1prompt] No windowId from sender, querying active tab...");const[c]=await chrome.tabs.query({active:!0,currentWindow:!0});s=c==null?void 0:c.windowId,console.log("[1prompt] Got windowId from query:",s)}s?(console.log("[1prompt] Opening side panel for window:",s),await chrome.sidePanel.open({windowId:s}),console.log("[1prompt] Side panel opened successfully")):console.error("[1prompt] Could not find windowId to open side panel")}catch(s){console.error("[1prompt] Failed to open side panel:",s)}})(),t({success:!0});break}case"EXTRACTION_FROM_PAGE":{const{result:n,mode:a}=r;y=n,console.log(`[1prompt SW] Received EXTRACTION_FROM_PAGE with ${n.prompts.length} prompts, mode: ${a}`);const s=(o=e.tab)==null?void 0:o.windowId;s&&chrome.sidePanel.open({windowId:s}).catch(()=>{}),a==="compile"&&n.prompts.length>0?(console.log("[1prompt SW] Mode is COMPILE - calling AI summarizer..."),(async()=>{try{const c=await C(),l=await U.summarize(n.prompts,{userId:c||void 0});console.log("[1prompt SW] AI summarization complete"),chrome.runtime.sendMessage({action:"EXTRACTION_FROM_PAGE_RESULT",result:{...n,summary:l.summary,promptCount:l.promptCount,model:l.model,provider:l.provider},mode:a}).catch(()=>{})}catch(c){console.error("[1prompt SW] AI summarization failed:",c),chrome.runtime.sendMessage({action:"EXTRACTION_FROM_PAGE_RESULT",result:n,mode:a,error:c.message||"AI summarization failed"}).catch(()=>{})}})()):(console.log("[1prompt SW] Broadcasting EXTRACTION_FROM_PAGE_RESULT via sendMessage..."),chrome.runtime.sendMessage({action:"EXTRACTION_FROM_PAGE_RESULT",result:n,mode:a}).catch(()=>{})),console.log("[1prompt SW] âœ… Result broadcast complete"),t({success:!0});break}case"EXTRACTION_RESULT":{const{result:n,mode:a}=r;y=n,e.tab&&a==="compile"&&n.prompts.length>0&&!n.summary?(console.log("[1prompt SW] Mode is COMPILE - calling AI summarizer..."),(async()=>{try{const s=await C(),c=await U.summarize(n.prompts,{userId:s||void 0});console.log("[1prompt SW] AI summarization complete");const l={...n,summary:c.summary,promptCount:c.promptCount,model:c.model,provider:c.provider};y=l,g({action:"EXTRACTION_RESULT",result:l,mode:a})}catch(s){console.error("[1prompt SW] AI summarization failed:",s),g({action:"EXTRACTION_RESULT",result:n,mode:a,error:s.message||"AI summarization failed"})}})()):g({action:"EXTRACTION_RESULT",result:n,mode:a}),t({success:!0});break}case"RE_SUMMARIZE":{if(!y||!y.prompts.length){t({success:!1,error:"No prompts available to refine"});break}console.log("[1prompt SW] RE_SUMMARIZE requested"),(async()=>{try{const n=await C(),a=await U.summarize(y.prompts,{userId:n||void 0}),s={...y,summary:a.summary,promptCount:a.promptCount,model:a.model,provider:a.provider};y=s,g({action:"EXTRACTION_RESULT",result:s,mode:"compile"})}catch(n){console.error("[1prompt SW] RE_SUMMARIZE failed:",n),g({action:"EXTRACTION_RESULT",result:y,mode:"compile",error:n.message||"AI refinement failed"})}})(),t({success:!0});break}case"STATUS_RESULT":{g(r),t({success:!0});break}case"EXTRACT_TRIGERED_FROM_PAGE":{console.log("[1prompt] Broadcasting page extraction trigger to sidepanel"),j={timestamp:Date.now()},g(r),t({success:!0});break}case"SAVE_SESSION_PROMPTS":{const{prompts:n,platform:a,conversationId:s}=r,c=new Date().toISOString().split("T")[0],l=s?`keylog_${a}_${s}`:`keylog_${a}_${c}`;chrome.storage.local.get([l],d=>{const m=d[l]||[],h=[...m],p=new Set(m.map(f=>X(f.content)));for(const f of n){const S=X(f.content);p.has(S)||(h.push({...f,conversationId:s||f.conversationId,savedAt:Date.now()}),p.add(S))}chrome.storage.local.set({[l]:h}),C().then(f=>{ye(n.length)})}),t({success:!0});break}case"GET_CONVERSATION_LOGS":{const{platform:n,conversationId:a}=r,s=new Date().toISOString().split("T")[0],c=`keylog_${n}_${a}`,l=`keylog_${n}_${s}`;return chrome.storage.local.get([c,l],async d=>{let m=d[c]||[];if(m.length===0&&d[l]&&(m=d[l].filter(p=>p.conversationId===a)),await C()&&m.length<5){console.log("[1prompt] Local logs sparse, fetching from cloud...");const p=[];if(p.length>0){const f=new Set(m.map(v=>v.content)),S=[...m];for(const v of p)f.has(v.content)||S.push(v);m=S.sort((v,L)=>v.timestamp-L.timestamp),chrome.storage.local.set({[c]:m})}}t({success:!0,prompts:m})}),!0}async function i(n,a,s){try{if(!await C()){s({success:!1,error:"Not logged in"});return}const l=new Map;for(const d of n){const m=d.conversationId||"default";l.has(m)||l.set(m,[]),l.get(m).push({content:d.content,timestamp:d.timestamp,conversationId:m,platform:a,captureMethod:d.captureMethod})}console.log(`[1prompt] Processing ${n.length} prompts for sync (local only)`),console.log(`[1prompt] Queued ${n.length} prompts for cloud sync`),s({success:!0,synced:n.length})}catch(c){console.error("[1prompt] Sync error:",c),s({success:!1,error:String(c)})}}case"CHECK_SIDEPANEL_OPEN":{t({isOpen:!0});break}case"GET_SYNC_STATUS":{t({success:!0,queueSize:0,isWriting:!1});break}default:t({success:!1,error:"Unknown action"})}return!0});async function ve(r){let e=chrome.runtime.connect({name:"keep-alive"});const t=setInterval(()=>{e?e.postMessage({action:"ping"}):e=chrome.runtime.connect({name:"keep-alive"})},25e3);e.onDisconnect.addListener(()=>{e=null});try{return await r()}finally{clearInterval(t),e&&e.disconnect()}}const z=new Set;chrome.tabs.onRemoved.addListener(r=>{z.delete(r)});var V;(V=chrome.webNavigation)==null||V.onHistoryStateUpdated.addListener(async r=>{if(r.frameId!==0)return;const e=re(r.url);if(e){if(z.has(r.tabId)){try{chrome.tabs.sendMessage(r.tabId,{action:"URL_CHANGED",url:r.url}),console.log(`[1prompt] Notified content script of URL change for ${e}`)}catch{z.delete(r.tabId)}return}try{await chrome.scripting.executeScript({target:{tabId:r.tabId},files:["content.js"]}),z.add(r.tabId),console.log(`[1prompt] Injected content script for ${e}`)}catch(t){console.warn("[1prompt] Could not inject content script:",t)}}});async function te(r){switch(console.log("[1prompt] Side panel message:",r.action),r.action){case"EXTRACT_PROMPTS":{const e=r.mode,[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t!=null&&t.id){console.log("[1prompt] Sending EXTRACT_PROMPTS to tab:",t.id);let o=0;const i=3;let n=null;const a=()=>{n=setTimeout(()=>{o<i?(console.warn(`[1prompt] No response from tab ${t.id}, retrying... (attempt ${o+1}/${i})`),o++,a()):g({action:"ERROR",error:"Content script not responding. Please refresh the page and try again."})},1e4),chrome.tabs.sendMessage(t.id,{action:"EXTRACT_PROMPTS",mode:e},s=>{n!==null&&(clearTimeout(n),n=null),chrome.runtime.lastError?(console.error("[1prompt] Error sending to tab:",chrome.runtime.lastError),o<i?(console.warn(`[1prompt] Retrying message send... (attempt ${o+1}/${i})`),o++,a()):g({action:"ERROR",error:"Could not connect to the page. Please refresh and try again."})):console.log("[1prompt] Content script acknowledged extraction:",s)})};a()}else g({action:"ERROR",error:"No active tab found. Please make sure a chat page is open."});break}case"GET_STATUS":{D();break}case"SUMMARIZE_PROMPTS":{const{prompts:e,userId:t,userEmail:o,authToken:i}=r;try{console.log(`[1prompt] Summarizing ${e.length} prompts...`);const n=await ve(async()=>await U.summarize(e,{userId:t,userEmail:o,authToken:i}));console.log("[1prompt] Summarization successful"),g({action:"SUMMARY_RESULT",result:n,success:!0})}catch(n){console.error("[1prompt] AI Summarization error, falling back to local:",n);try{const a=await W.summarize(e);g({action:"SUMMARY_RESULT",result:a,success:!0,error:n instanceof Error?n.message:"AI Backend unavailable. Using local summarization."})}catch(a){console.error("[1prompt] Local summarization also failed:",a);const s=e.map(c=>c.content).join(`

`);g({action:"SUMMARY_RESULT",result:{original:e,summary:s,promptCount:{before:e.length,after:e.length}},success:!0,error:"Summarization failed. Showing raw content."})}}break}}}function g(r){chrome.runtime.sendMessage(r).catch(()=>{})}chrome.runtime.onInstalled.addListener(async r=>{if(console.log("[1prompt] Extension installed:",r.reason),r.reason==="install"){const{hasSeenWelcome:e}=await chrome.storage.local.get("hasSeenWelcome");e||(chrome.tabs.create({url:"https://1-prompt.in/install"}),chrome.storage.local.set({hasSeenWelcome:!0}))}});chrome.runtime.setUninstallURL&&chrome.runtime.setUninstallURL("https://1-prompt.in/uninstall");chrome.tabs.onActivated.addListener(()=>{D()});chrome.tabs.onUpdated.addListener((r,e,t)=>{e.status==="complete"&&t.active&&D()});async function D(){var r;try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(console.log("[1prompt] Checking tab status:",(r=e==null?void 0:e.url)==null?void 0:r.substring(0,50)),!(e!=null&&e.id)){console.log("[1prompt] No active tab found");return}if(!e.url||e.url.startsWith("chrome://")||e.url.startsWith("edge://")||e.url.startsWith("about:")){console.log("[1prompt] Restricted URL, sending unsupported"),g({action:"STATUS_RESULT",supported:!1,platform:null});return}const t=re(e.url);console.log("[1prompt] URL-based platform detection:",t),chrome.tabs.sendMessage(e.id,{action:"GET_STATUS"},async o=>{if(chrome.runtime.lastError)if(console.log("[1prompt] Content script not ready:",chrome.runtime.lastError.message),t){console.log("[1prompt] Auto-injecting content script for",t);try{await chrome.scripting.executeScript({target:{tabId:e.id},files:["content.js"]}),console.log("[1prompt] âœ… Content script auto-injected successfully"),setTimeout(()=>{chrome.tabs.sendMessage(e.id,{action:"GET_STATUS"},i=>{i?(console.log("[1prompt] Content script now responding after auto-inject"),g(i)):g({action:"STATUS_RESULT",supported:!1,platform:t})})},500)}catch(i){console.warn("[1prompt] Auto-inject failed:",i),g({action:"STATUS_RESULT",supported:!1,platform:t})}}else g({action:"STATUS_RESULT",supported:!1,platform:null});else o&&(console.log("[1prompt] Content script responded:",o),g(o))})}catch(e){console.error("[1prompt] Error checking tab status:",e)}}function re(r){try{const e=new URL(r),t=e.hostname.toLowerCase(),o=e.pathname.toLowerCase();return t.includes("chatgpt.com")||t.includes("chat.openai.com")||t.includes("openai.com")&&o.includes("chat")?"ChatGPT":t.includes("claude.ai")||t.includes("anthropic.com")?"Claude":t.includes("gemini.google.com")||t.includes("bard.google.com")||t.includes("google.com")&&(o.includes("gemini")||o.includes("bard"))?"Gemini":t.includes("perplexity.ai")||t.includes("perplexity.com")?"Perplexity":t.includes("deepseek.com")||t.includes("chat.deepseek.com")?"DeepSeek":t.includes("lovable.dev")||t.includes("lovable.ai")||t.includes("gptengineer.app")||t.includes("run.gptengineer.app")?"Lovable":t.includes("bolt.new")||t.includes("bolt.dev")||t.includes("stackblitz.com")?"Bolt.new":t.includes("cursor.sh")||t.includes("cursor.com")||t.includes("cursor.ai")?"Cursor":t.includes("meta.ai")||t.includes("ai.meta.com")||t.includes("facebook.com")&&o.includes("ai")||t.includes("meta.ai")?"Meta AI":null}catch{return null}}chrome.commands.onCommand.addListener(async r=>{if(console.log("[1prompt] Command received:",r),r==="extract-prompts"){const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(e!=null&&e.id){try{await chrome.sidePanel.open({windowId:e.windowId})}catch(t){console.warn("[1prompt] Could not open side panel via command:",t)}chrome.tabs.sendMessage(e.id,{action:"EXTRACT_PROMPTS",mode:"raw"})}}});function X(r){return r.toLowerCase().trim().replace(/\s+/g," ").slice(0,200)}

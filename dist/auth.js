import{b as u,d as g,e as d,f as m}from"./firebase.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();async function A(){return new Promise(e=>{chrome.identity.getAuthToken({interactive:!1},t=>{if(chrome.runtime.lastError||!t){e(null);return}e(t)})})}const a="promptExtractor_user";let c={guest:5,free:10,go:25,pro:100,infi:999,admin:999};async function l(){try{const e=await m();c={guest:e.guest,free:e.free,go:e.go||25,pro:e.pro,infi:e.infi||999,admin:999},console.log("[Auth] Loaded quotas from Firebase:",c)}catch{console.log("[Auth] Using default quotas")}}async function p(){return new Promise(e=>{chrome.storage.local.get([a],t=>{e(t[a]||null)})})}async function f(e){return new Promise(t=>{e?chrome.storage.local.set({[a]:e},t):chrome.storage.local.remove([a],t)})}async function w(){return new Promise(e=>{chrome.storage.local.get(["usage_count"],t=>{e(t.usage_count||0)})})}async function v(){return console.log("[Auth] Starting Google Sign-In flow..."),new Promise((e,t)=>{chrome.identity.getAuthToken({interactive:!0},async n=>{var s;if(chrome.runtime.lastError||!n){console.error("[Auth] Google Auth Token failed:",chrome.runtime.lastError),t(new Error(((s=chrome.runtime.lastError)==null?void 0:s.message)||"Failed to get auth token"));return}console.log("[Auth] Google token obtained, fetching user info...");try{const o=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${n}`}});if(!o.ok){const h=await o.text();throw console.error("[Auth] User info fetch failed:",o.status,h),new Error("Failed to fetch user info from Google")}const r=await o.json(),i={id:r.id,email:r.email,name:r.name||r.email.split("@")[0],picture:r.picture};console.log("[Auth] Authenticated as:",i.email),await u(i.id),await d(i),await f(i),await l(),console.log("[Auth] Complete sign-in flow finished successfully"),e(i)}catch(o){console.error("[Auth] Sign-in flow interrupted:",o),n&&chrome.identity.removeCachedAuthToken({token:n},()=>{console.log("[Auth] Cached token removed due to error")}),t(o)}})})}async function E(){return await u(null),await g(),new Promise(e=>{chrome.identity.getAuthToken({interactive:!1},t=>{t&&chrome.identity.removeCachedAuthToken({token:t},()=>{fetch(`https://accounts.google.com/o/oauth2/revoke?token=${t}`)}),f(null).then(e)})})}function P(e){const t=(n,s)=>{s==="local"&&n[a]&&e(n[a].newValue||null)};return chrome.storage.onChanged.addListener(t),()=>{chrome.storage.onChanged.removeListener(t)}}async function T(){const e=await p(),t=await w();return l().catch(console.error),{user:e,tier:"free",usage:{used:t,limit:10},isLoading:!1}}export{E as a,v as b,A as g,T as i,P as s};

var g=Object.defineProperty;var m=(t,e,r)=>e in t?g(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var n=(t,e,r)=>m(t,typeof e!="symbol"?e+"":e,r);const h={backend:{url:"https://1prompt-backend.amaravadhibharath.workers.dev"},features:{telemetryEnabled:!0,remoteSelectorEnabled:!0},analytics:{posthogKey:"",posthogHost:"https://us.i.posthog.com"},email:{resendKey:""},ai:{defaultProvider:"auto",model:""}};class y{constructor(){n(this,"config",h);n(this,"loaded",!1)}async load(){if(this.loaded)return this.config;try{const e=await fetch(`${h.backend.url}/config/runtime`);if(e.ok){const s=(await e.json()).config;this.config=this.mergeConfig(h,s),console.log("[Config] Loaded runtime config from Backend")}}catch{console.log("[Config] Using bundled config")}return this.loaded=!0,this.config}mergeConfig(e,r){return{backend:{...e.backend,...r.backend},features:{...e.features,...r.features},analytics:{...e.analytics,...r.analytics},email:{...e.email,...r.email},ai:{...e.ai,...r.ai}}}get backend(){return this.config.backend}get features(){return this.config.features}get analytics(){return this.config.analytics}get email(){return this.config.email}get ai(){return this.config.ai}}const c=new y,S=Object.freeze(Object.defineProperty({__proto__:null,config:c},Symbol.toStringTag,{value:"Module"}));class w{constructor(e){n(this,"state","CLOSED");n(this,"failures",0);n(this,"lastFailureTime",0);n(this,"successCount",0);n(this,"config");this.config=e}async execute(e){if(this.state==="OPEN")if(Date.now()-this.lastFailureTime>this.config.resetTimeout)this.state="HALF_OPEN",console.log("[CircuitBreaker] Attempting recovery (HALF_OPEN)");else throw new Error("Service temporarily unavailable - please try again");try{const r=await e();return this.onSuccess(),r}catch(r){throw this.onFailure(),r}}onSuccess(){this.failures=0,this.state==="HALF_OPEN"&&(this.successCount++,this.successCount>=2&&(this.state="CLOSED",this.successCount=0,console.log("[CircuitBreaker] Service recovered (CLOSED)")))}onFailure(){this.failures++,this.lastFailureTime=Date.now(),this.successCount=0,this.failures>=this.config.failureThreshold&&(this.state="OPEN",console.error(`[CircuitBreaker] Circuit OPEN after ${this.failures} failures`))}isHealthy(){return this.state==="CLOSED"}}const k={maxRetries:3,initialDelay:1e3,maxDelay:1e4,backoffMultiplier:2},p={failureThreshold:5,resetTimeout:6e4},C=new w(p);async function d(t,e=k,r=1){try{return await t()}catch(s){if(s.status===429||s.status===401||s.status===403)throw s;if(r>=e.maxRetries)throw console.error(`[Retry] All ${e.maxRetries} attempts failed`),s;const o=Math.min(e.initialDelay*Math.pow(e.backoffMultiplier,r-1),e.maxDelay);return console.warn(`[Retry] Attempt ${r}/${e.maxRetries} - waiting ${o}ms`),await new Promise(i=>setTimeout(i,o)),d(t,e,r+1)}}async function E(t,e={},r=3e4){const s=new AbortController,o=setTimeout(()=>s.abort(),r);try{const i=await fetch(t,{...e,signal:s.signal});return clearTimeout(o),i}catch(i){throw clearTimeout(o),i.name==="AbortError"?new Error(`Request timeout after ${r/1e3}s`):i}}async function l(t,e={}){return console.log(`[resilientFetch] Starting request to ${t}`),C.execute(async()=>(console.log("[resilientFetch] Circuit breaker healthy, proceeding with request"),d(async()=>{console.log("[resilientFetch] Making fetch request with timeout 30s");const r=await E(t,e);if(console.log(`[resilientFetch] Response received: ${r.status}`),!r.ok&&r.status>=500){const s=new Error(`Server error: ${r.status}`);throw s.status=r.status,s}return r})))}const a="prompt_extractor_user_id";async function u(){const t={"Content-Type":"application/json"},e=await T();return e&&(t.Authorization=`Bearer ${e}`),t}async function T(){return new Promise(t=>{chrome.identity.getAuthToken({interactive:!1},e=>{if(chrome.runtime.lastError||!e){t(null);return}t(e)})})}async function F(t){t?(await chrome.storage.session.set({[a]:t}),await chrome.storage.local.set({[a]:t})):(await chrome.storage.session.remove([a]),await chrome.storage.local.remove([a])),console.log("[Backend] User set:",t?"logged in":"logged out")}async function O(){await chrome.storage.session.remove([a]),await chrome.storage.local.remove([a]),console.log("[Backend] Signed out")}async function B(){const t=await chrome.storage.session.get([a]);return t[a]?t[a]:(await chrome.storage.local.get([a]))[a]||null}async function _(t,e){try{const r=await l(`${c.backend.url}/history`,{method:"POST",headers:await u(),body:JSON.stringify({item:e})});if(!r.ok)throw new Error(`Backend error: ${r.status}`);console.log("[Backend] Saved history:",e.id)}catch(r){console.error("[Backend] Save history error:",r)}}async function $(t){try{const e=await l(`${c.backend.url}/history?userId=${t}`,{method:"GET",headers:await u()});if(!e.ok){if(e.status===404)return[];throw new Error(`Backend error: ${e.status}`)}return(await e.json()).history||[]}catch(e){throw console.error("[Backend] Get history error:",e),e}}async function v(t){try{const e=await l(`${c.backend.url}/user/profile`,{method:"POST",headers:await u(),body:JSON.stringify(t)});if(!e.ok)throw new Error(`Backend error: ${e.status}`);console.log("[Backend] Saved user profile")}catch(e){console.warn("[Backend] Save profile failed (non-critical):",e)}}const f={guest:3,free:10,go:25,pro:100,infi:999};async function A(){try{const t=await l(`${c.backend.url}/config/quotas`,{method:"GET",headers:await u()});return t.ok&&(await t.json()).quotas||f}catch(t){return console.error("[Backend] Get quotas error:",t),f}}function D(t,e){if(!e||!Array.isArray(e))return t;const r=new Set(e.map(o=>o.id)),s=[...e];for(const o of t)r.has(o.id)||s.push(o);return s.sort((o,i)=>i.timestamp-o.timestamp),s}export{T as a,F as b,c,O as d,v as e,A as f,$ as g,B as h,S as i,D as m,l as r,_ as s};
